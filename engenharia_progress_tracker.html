<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Progresso - Engenharia de Controle e Automação IF-ES</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --light-bg: #f8f9fa;
            --dark-bg: #2c3e50;
            --text-color: #333;
            --border-radius: 15px;
            --shadow: 0 8px 25px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }


        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
            transition: var(--transition);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-container {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1em;
            transition: var(--transition);
            background: white;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .theme-toggle {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 2.2em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .progress-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 120px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .completed { color: var(--success-color); }
        .available { color: var(--info-color); }
        .blocked { color: var(--danger-color); }
        .total { color: var(--secondary-color); }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .chart-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .chart-card:hover {
            transform: translateY(-5px);
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--text-color);
            text-align: center;
        }

        .gpa-display {
            background: linear-gradient(135deg, var(--success-color), var(--info-color));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }

        .gpa-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .gpa-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .grade-input {
            width: 60px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9em;
        }

        .grade-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .export-btn {
            background: var(--info-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .export-btn.success {
            background: var(--success-color);
        }

        .export-btn.warning {
            background: var(--warning-color);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            box-shadow: var(--shadow);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .close:hover {
            color: var(--danger-color);
        }

        .semester-planner {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }

        .planner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .add-semester-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .add-semester-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .planned-semester {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid var(--primary-color);
        }

        .semester-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .planned-subjects {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .planned-subject {
            background: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .remove-subject {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.8em;
        }


        .critical-analysis {
            margin: 20px 0;
        }

        .critical-subjects-card {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .critical-subjects-card h3 {
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .critical-subjects-card p {
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .critical-subject {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .critical-subject:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(5px);
        }

        .critical-subject-info {
            flex: 1;
        }

        .critical-subject-code {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .critical-subject-name {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .critical-subject-impact {
            text-align: center;
            min-width: 80px;
        }

        .impact-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .impact-label {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .priority-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 10px;
        }

        .priority-critical {
            background: #e74c3c;
            color: white;
        }

        .priority-high {
            background: #f39c12;
            color: white;
        }

        .priority-medium {
            background: #3498db;
            color: white;
        }

        .subject-critical {
            border: 3px solid #e74c3c;
            position: relative;
        }

        .subject-critical::before {
            content: "⚠️ CRÍTICA";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
            z-index: 10;
        }

        .subject-high-priority {
            border: 2px solid #f39c12;
        }

        .alert-banner {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px;
            border-radius: 0;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse 2s infinite;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .alert-banner i {
            font-size: 1.5em;
        }

        .alert-banner-content {
            flex: 1;
        }

        .alert-banner-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .alert-banner-message {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .graduation-planner {
            max-width: 1200px;
            margin: 0 auto;
        }

        .planner-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .planner-header h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .graduation-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .planning-options {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .option-group label {
            font-weight: bold;
            color: var(--text-color);
        }

        .option-group select,
        .option-group input {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
        }

        .graduation-timeline {
            display: grid;
            gap: 20px;
        }

        .semester-plan {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary-color);
        }

        .semester-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .semester-plan-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .semester-plan-stats {
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .semester-subjects {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
        }

        .planned-subject {
            background: var(--light-bg);
            padding: 12px;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .planned-subject.completed {
            background: linear-gradient(135deg, #a8e6cf, #7fcdcd);
            border-color: #27ae60;
        }

        .planned-subject.critical {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
        }

        .planned-subject.high-priority {
            border-color: #f39c12;
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
        }

        .planned-subject-code {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 0.9em;
        }

        .planned-subject-name {
            font-size: 0.85em;
            color: var(--text-color);
            margin-top: 2px;
        }

        .planned-subject-info {
            font-size: 0.75em;
            color: #3498db;
            margin-top: 3px;
        }

        .legend-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .legend-container h4 {
            margin-bottom: 15px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 5px;
            border: 2px solid transparent;
        }

        .legend-color.completed {
            background: linear-gradient(135deg, #a8e6cf, #7fcdcd);
            border-color: var(--success-color);
        }

        .legend-color.available {
            background: linear-gradient(135deg, #b3d9ff, #87ceeb);
            border-color: var(--info-color);
        }

        .legend-color.blocked {
            background: linear-gradient(135deg, #ffb3b3, #ffc0cb);
            border-color: var(--danger-color);
        }

        .legend-color.critical {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border: 3px solid var(--danger-color);
            position: relative;
        }

        .legend-color.critical::after {
            content: "⚠️";
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 0.7em;
        }

        .legend-color.high-priority {
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
            border: 2px solid var(--warning-color);
        }

        .semesters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .semester {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .semester:hover {
            transform: translateY(-5px);
        }

        .semester-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .subject {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .subject:hover {
            transform: translateX(5px);
        }

        .subject.completed {
            background: linear-gradient(135deg, #a8e6cf, #7fcdcd);
            border-color: #27ae60;
        }

        .subject.available {
            background: linear-gradient(135deg, #b3d9ff, #87ceeb);
            border-color: #3498db;
        }

        .subject.blocked {
            background: linear-gradient(135deg, #ffb3b3, #ffc0cb);
            border-color: #e74c3c;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .subject-checkbox {
            margin-right: 12px;
            transform: scale(1.3);
            margin-top: 2px;
        }

        .subject-content {
            flex: 1;
        }

        .subject-header {
            display: flex;
            align-items: center;
            margin-bottom: 2px;
        }

        .subject-code {
            font-weight: bold;
            margin-right: 10px;
            min-width: 80px;
            font-size: 0.85em;
            background: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .subject-name {
            flex: 1;
            font-size: 0.9em;
            line-height: 1.3;
        }

        .subject-info {
            font-size: 0.75em;
            color: #666;
            margin-top: 3px;
            opacity: 0.8;
        }

        .prerequisites {
            font-size: 0.8em;
            color: #7f8c8d;
            margin-top: 5px;
            padding-left: 0;
            background: rgba(231, 76, 60, 0.1);
            padding: 5px 8px;
            border-radius: 5px;
            border-left: 3px solid #e74c3c;
        }

        .reset-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reset-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .floating-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .floating-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            transition: var(--transition);
            box-shadow: var(--shadow);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-btn:hover {
            background: var(--secondary-color);
            transform: scale(1.1);
        }

        .floating-btn.success {
            background: var(--success-color);
        }

        .floating-btn.warning {
            background: var(--warning-color);
        }

        .filter-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9em;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .filter-btn:hover {
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            z-index: 1001;
            transform: translateX(400px);
            transition: var(--transition);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        @media (max-width: 768px) {
            .semesters-grid {
                grid-template-columns: 1fr;
            }
            
            .progress-stats {
                gap: 15px;
            }
            
            .stat-card {
                min-width: 100px;
                padding: 10px 15px;
            }

            .subject-code {
                min-width: 70px;
                font-size: 0.8em;
            }

            .subject-name {
                font-size: 0.85em;
            }

            .header-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-container {
                max-width: none;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .export-buttons {
                flex-direction: column;
            }

            .floating-controls {
                bottom: 10px;
                right: 10px;
            }

            .floating-btn {
                width: 45px;
                height: 45px;
                font-size: 1em;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                padding: 8px 16px;
                font-size: 0.9em;
            }

            .legend-items {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .legend-item {
                font-size: 0.85em;
            }

            .legend-color {
                width: 18px;
                height: 18px;
            }
        }
    </style>
</head>
<body>
    <button class="reset-btn" onclick="resetProgress()">
        <i class="fas fa-redo"></i> Resetar
    </button>
    
    
    <div class="container">
        <div class="header-controls">
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar disciplinas...">
                <i class="fas fa-search search-icon"></i>
            </div>
        </div>

        <h1>Controle de Progresso</h1>
        <p class="subtitle">Engenharia de Controle e Automação - Instituto Federal do Espírito Santo</p>
        
        <div class="progress-stats">
            <div class="stat-card">
                <div class="stat-number completed" id="completed-count">0</div>
                <div class="stat-label">Concluídas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number available" id="available-count">0</div>
                <div class="stat-label">Disponíveis</div>
            </div>
            <div class="stat-card">
                <div class="stat-number blocked" id="blocked-count">0</div>
                <div class="stat-label">Bloqueadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number total" id="total-count">0</div>
                <div class="stat-label">Total</div>
            </div>
        </div>



        <div class="tabs">
            <button class="tab active" onclick="switchTab('curriculum')">Currículo</button>
            <button class="tab" onclick="switchTab('graduation')">Planejamento de Graduação <span style="background: #ff6b35; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7em; margin-left: 5px;">BETA</span></button>
            <button class="tab" onclick="switchTab('analytics')">Disciplinas Críticas</button>
        </div>

        <div class="tab-content active" id="curriculum-tab">
            <div class="legend-container">
                <h4><i class="fas fa-info-circle"></i> Legenda das Cores:</h4>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color completed"></div>
                        <span>Concluída</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color available"></div>
                        <span>Disponível</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color blocked"></div>
                        <span>Bloqueada</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color critical"></div>
                        <span>Crítica</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color high-priority"></div>
                        <span>Alta Prioridade</span>
                    </div>
            </div>
        </div>

        <div class="filter-buttons">
            <button class="filter-btn active highlight-btn" onclick="filterSemesters('all')">Todos os Períodos</button>
            <button class="filter-btn" onclick="filterSemesters('available')">Apenas Disponíveis</button>
            <button class="filter-btn" onclick="filterSemesters('completed')">Apenas Concluídas</button>
            <button class="filter-btn" onclick="filterSemesters('blocked')">Apenas Bloqueadas</button>
        </div>

        <div class="semesters-grid" id="semesters-container">
            <!-- Semestres serão gerados aqui -->
            </div>
        </div>



        <div class="tab-content" id="analytics-tab">
            <div class="critical-analysis">
                <div class="critical-subjects-card">
                    <h3><i class="fas fa-exclamation-triangle"></i> Disciplinas Críticas</h3>
                    <p>Disciplinas que bloqueiam o maior número de outras disciplinas (incluindo efeito cascata)</p>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Como funciona a análise:</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 0.9em; opacity: 0.9;">
                            <li><strong>Impacto Direto:</strong> Disciplinas que dependem diretamente desta</li>
                            <li><strong>Impacto Cascata:</strong> Disciplinas que dependem das dependências (efeito dominó)</li>
                            <li><strong>Total:</strong> Soma dos dois impactos para mostrar o verdadeiro alcance</li>
                        </ul>
                        <p style="margin-top: 10px; font-size: 0.85em; opacity: 0.8;">
                            <strong>Exemplo:</strong> Se "Sistemas Digitais I" bloqueia "Sistemas Digitais II", 
                            e "Sistemas Digitais II" bloqueia outras 5 disciplinas, então "Sistemas Digitais I" 
                            tem impacto total de 6 disciplinas (1 direto + 5 em cascata).
                        </p>
                    </div>
                    <div id="critical-subjects-list">
                        <!-- Lista de disciplinas críticas será gerada aqui -->
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="graduation-tab">
            <div class="graduation-planner">
                <div class="planner-header">
                    <h3><i class="fas fa-graduation-cap"></i> Planejamento de Graduação</h3>
                    <p>Análise inteligente do tempo necessário para concluir o curso</p>
                </div>
                
                <div class="graduation-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-semesters">-</div>
                        <div class="stat-label">Semestres Restantes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-years">-</div>
                        <div class="stat-label">Anos Restantes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avg-subjects-per-semester">-</div>
                        <div class="stat-label">Média de Disciplinas/Semestre</div>
                    </div>
                </div>

                <div class="planning-options">
                    <div class="option-group">
                        <label for="includeCompleted">Incluir disciplinas concluídas:</label>
                        <input type="checkbox" id="includeCompleted" checked onchange="updateGraduationPlan()">
                    </div>
                </div>

                <div class="graduation-timeline" id="graduation-timeline">
                    <!-- Cronograma será gerado aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para importação de dados -->

    <!-- Rodapé com informações de versão e autor -->
    <footer style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #e0e0e0; background: var(--light-bg); color: var(--text-muted); font-size: 0.9em;">
        <div style="margin-bottom: 10px;">
            <strong>Sistema de Acompanhamento Acadêmico - Engenharia de Controle e Automação</strong>
        </div>
        <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;">
            <span><i class="fas fa-code"></i> Versão 2.0.0</span>
            <span><i class="fas fa-user"></i> Autor: Enio Costa Soeiro</span>
            <span><i class="fas fa-graduation-cap"></i> IFES - Instituto Federal do Espírito Santo</span>
        </div>
        <div style="margin-top: 10px; font-size: 0.8em; opacity: 0.8;">
            <i class="fas fa-info-circle"></i> Sistema desenvolvido para acompanhamento do progresso acadêmico
        </div>
    </footer>

    <script>
        // Informações do Sistema
        const APP_VERSION = '2.0.0';
        const APP_AUTHOR = 'Enio Costa Soeiro';
        const APP_INSTITUTION = 'IFES - Instituto Federal do Espírito Santo';
        
        // Sistema de Banco de Dados SQLite
        let db = null;
        let SQL = null;

        // Inicializar SQLite
        async function initSQLite() {
            try {
                SQL = await initSqlJs({
                    locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/${file}`
                });
                
                // Tentar carregar banco existente do localStorage
                const savedDb = localStorage.getItem('academicProgressDB');
                if (savedDb) {
                    const data = new Uint8Array(JSON.parse(savedDb));
                    db = new SQL.Database(data);
                } else {
                    // Criar novo banco
                    db = new SQL.Database();
                    createTables();
                }
                
                console.log('SQLite inicializado com sucesso!');
                return true;
            } catch (error) {
                console.error('Erro ao inicializar SQLite:', error);
                // Fallback para localStorage se SQLite falhar
                return false;
            }
        }

        function createTables() {
            // Tabela de disciplinas concluídas
            db.exec(`
                CREATE TABLE IF NOT EXISTS completed_subjects (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    subject_code TEXT UNIQUE NOT NULL,
                    completed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    notes TEXT
                )
            `);

            // Tabela de semestres planejados
            db.exec(`
                CREATE TABLE IF NOT EXISTS planned_semesters (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    subjects TEXT NOT NULL,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            `);


            // Tabela de histórico de mudanças
            db.exec(`
                CREATE TABLE IF NOT EXISTS change_history (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    action TEXT NOT NULL,
                    subject_code TEXT,
                    details TEXT,
                    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            `);

            // Tabela de backups
            db.exec(`
                CREATE TABLE IF NOT EXISTS backups (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    backup_name TEXT NOT NULL,
                    backup_data BLOB NOT NULL,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    description TEXT
                )
            `);
        }

        function saveDatabase() {
            if (db) {
                const data = db.export();
                const array = Array.from(data);
                localStorage.setItem('academicProgressDB', JSON.stringify(array));
            }
        }

        function loadCompletedSubjects() {
            if (!db) return [];
            
            try {
                const stmt = db.prepare('SELECT subject_code FROM completed_subjects');
                const result = [];
                while (stmt.step()) {
                    result.push(stmt.getAsObject().subject_code);
                }
                stmt.free();
                return result;
            } catch (error) {
                console.error('Erro ao carregar disciplinas concluídas:', error);
                return [];
            }
        }

        function saveCompletedSubjects(subjects) {
            if (!db) return;
            
            try {
                // Limpar tabela
                db.exec('DELETE FROM completed_subjects');
                
                // Inserir novas disciplinas
                const stmt = db.prepare('INSERT INTO completed_subjects (subject_code) VALUES (?)');
                subjects.forEach(code => {
                    stmt.run([code]);
                });
                stmt.free();
                
                // Salvar no localStorage
                saveDatabase();
            } catch (error) {
                console.error('Erro ao salvar disciplinas concluídas:', error);
            }
        }

        function addChangeHistory(action, subjectCode = null, details = null) {
            if (!db) return;
            
            try {
                const stmt = db.prepare('INSERT INTO change_history (action, subject_code, details) VALUES (?, ?, ?)');
                stmt.run([action, subjectCode, details]);
                stmt.free();
                saveDatabase();
            } catch (error) {
                console.error('Erro ao adicionar histórico:', error);
            }
        }

        function getChangeHistory(limit = 50) {
            if (!db) return [];
            
            try {
                const stmt = db.prepare('SELECT * FROM change_history ORDER BY timestamp DESC LIMIT ?');
                stmt.bind([limit]);
                const result = [];
                while (stmt.step()) {
                    result.push(stmt.getAsObject());
                }
                stmt.free();
                return result;
            } catch (error) {
                console.error('Erro ao obter histórico:', error);
                return [];
            }
        }


        // Dados das disciplinas baseados na matriz curricular real do IF-ES
        const curriculumData = {
            1: [
                {code: 'NC.25', name: 'Comunicação e Expressão', credits: 2, hours: 30, prerequisites: []},
                {code: 'ETICA', name: 'Ética e Legislação Profissional', credits: 3, hours: 45, prerequisites: []},
                {code: 'INTCOMP', name: 'Introdução à Computação para Controle e Automação', credits: 4, hours: 60, prerequisites: []},
                {code: 'INTGEO', name: 'Introdução à Geometria Analítica e Variáveis Complexas', credits: 2, hours: 30, prerequisites: []},
                {code: 'PRECALC', name: 'Pré-Cálculo', credits: 6, hours: 90, prerequisites: []},
                {code: 'QUIMGE', name: 'Química Geral e Experimental', credits: 5, hours: 75, prerequisites: []},
                {code: 'NC.41', name: 'Sociologia e Cidadania', credits: 2, hours: 30, prerequisites: []}
            ],
            2: [
                {code: 'NC.18', name: 'Algoritmos e Estrutura de Dados', credits: 4, hours: 60, prerequisites: ['INTCOMP']},
                {code: 'CALCDIF', name: 'Cálculo Diferencial e Integral I', credits: 6, hours: 90, prerequisites: ['PRECALC']},
                {code: 'NC.23', name: 'Ciências do Ambiente', credits: 2, hours: 30, prerequisites: ['QUIMGE']},
                {code: 'NC.30', name: 'Física Geral I', credits: 6, hours: 90, prerequisites: ['PRECALC']},
                {code: 'NC.35', name: 'Geometria Analítica', credits: 4, hours: 60, prerequisites: ['INTGEO']},
                {code: 'SISTDIG', name: 'Sistemas Digitais I', credits: 3, hours: 45, prerequisites: ['INTCOMP']}
            ],
            3: [
                {code: 'NC.17', name: 'Álgebra Linear', credits: 4, hours: 60, prerequisites: ['NC.35']},
                {code: 'CECA.27', name: 'Cálculo Diferencial e Integral II', credits: 6, hours: 90, prerequisites: ['NC.35', 'CALCDIF']},
                {code: 'NC.31', name: 'Física Geral II', credits: 6, hours: 90, prerequisites: ['NC.30', 'CALCDIF']},
                {code: 'PROGOBJ', name: 'Programação Orientada a Objetos', credits: 4, hours: 60, prerequisites: ['NC.18']},
                {code: 'SISTDIGII', name: 'Sistemas Digitais II', credits: 4, hours: 60, prerequisites: ['SISTDIG']}
            ],
            4: [
                {code: 'CECA.32', name: 'Cálculo Diferencial e Integral III', credits: 5, hours: 75, prerequisites: ['NC.17', 'CECA.27']},
                {code: 'NC.22', name: 'Cálculo Numérico', credits: 4, hours: 60, prerequisites: ['PROGOBJ']},
                {code: 'CECA.35', name: 'Circuitos Elétricos', credits: 4, hours: 60, prerequisites: []},
                {code: 'NC.33', name: 'Física Geral III', credits: 6, hours: 90, prerequisites: ['NC.31', 'CECA.27']},
                {code: 'CECA.34', name: 'Laboratório de Circuitos Elétricos', credits: 2, hours: 30, prerequisites: []},
                {code: 'CECA.30', name: 'Projetos com Sistemas Digitais', credits: 3, hours: 45, prerequisites: ['SISTDIGII']}
            ],
            5: [
                {code: 'CECA.068', name: 'Análise de Sinais e Sistemas', credits: 4, hours: 60, prerequisites: ['CECA.32', 'CECA.35']},
                {code: 'CECA.37', name: 'Arquitetura de Computadores e Sistemas Embarcados', credits: 5, hours: 75, prerequisites: ['PROGOBJ', 'CECA.30']},
                {code: 'CECA.40', name: 'Dispositivos e Circuitos Eletrônicos Básicos', credits: 4, hours: 60, prerequisites: ['CECA.34', 'CECA.35']},
                {code: 'CECA.41', name: 'Fenômenos de Transporte', credits: 4, hours: 60, prerequisites: ['NC.31', 'CECA.32']},
                {code: 'CECA.42', name: 'Física Geral IV', credits: 5, hours: 75, prerequisites: ['NC.33', 'CECA.32']},
                {code: 'CECA.39', name: 'Laboratório de Dispositivos e Circuitos Eletrônicos Básicos', credits: 2, hours: 30, prerequisites: ['CECA.40']}
            ],
            6: [
                {code: 'NC.24', name: 'Ciência dos Materiais', credits: 4, hours: 60, prerequisites: ['QUIMGE']},
                {code: 'CECA.073', name: 'Comunicação de Dados', credits: 4, hours: 60, prerequisites: ['CECA.37']},
                {code: 'CECA.47', name: 'Instrumentação Industrial I', credits: 4, hours: 60, prerequisites: ['CECA.40', 'CECA.41']},
                {code: 'CECA.46', name: 'Laboratório de Instrumentação Industrial', credits: 2, hours: 30, prerequisites: ['CECA.47']},
                {code: 'NC.36', name: 'Mecânica dos Sólidos', credits: 3, hours: 45, prerequisites: ['NC.17', 'NC.30', 'CALCDIF']},
                {code: 'CECA.45', name: 'Modelagem de Sistemas Dinâmicos', credits: 3, hours: 45, prerequisites: ['CECA.068', 'CECA.40', 'CECA.41']},
                {code: 'CECA.44', name: 'Sistemas Microcontrolados', credits: 4, hours: 60, prerequisites: ['CECA.37']}
            ],
            7: [
                {code: 'CECA.039', name: 'Controle Automático', credits: 6, hours: 90, prerequisites: ['CECA.45']},
                {code: 'CECA.052', name: 'Eletrônica de Potência', credits: 4, hours: 60, prerequisites: ['CECA.39', 'CECA.40']},
                {code: 'NC.38', name: 'Probabilidade e Estatística', credits: 4, hours: 60, prerequisites: ['CECA.32']},
                {code: 'CECA.52', name: 'Redes para Controle e Automação', credits: 6, hours: 90, prerequisites: ['CECA.073']},
                {code: 'NC.40', name: 'Segurança do Trabalho', credits: 2, hours: 30, prerequisites: []},
                {code: 'CECA.51', name: 'Segurança em Área Industrial', credits: 2, hours: 30, prerequisites: []}
            ],
            8: [
                {code: 'CECA.62', name: 'Comandos e Proteção em Baixa Tensão', credits: 2, hours: 30, prerequisites: ['CECA.052']},
                {code: 'CECA.059', name: 'Controle de Processos', credits: 4, hours: 60, prerequisites: ['CECA.039', 'CECA.45']},
                {code: 'NC.29', name: 'Expressão Gráfica', credits: 3, hours: 45, prerequisites: ['NC.35']},
                {code: 'CECA.60', name: 'Inteligência Artificial', credits: 4, hours: 60, prerequisites: ['NC.22', 'NC.38', 'PROGOBJ']},
                {code: 'NC.37', name: 'Metodologia Científica', credits: 2, hours: 30, prerequisites: ['NC.25']},
                {code: 'CECA.57', name: 'Processo de Fabricação', credits: 2, hours: 30, prerequisites: ['NC.24']},
                {code: 'CECA.59', name: 'Programação de Controlador Lógico Programável', credits: 4, hours: 60, prerequisites: ['CECA.44']}
            ],
            9: [
                {code: 'CECA.83', name: 'Acionamento de Máquinas Elétricas', credits: 4, hours: 60, prerequisites: ['CECA.59', 'CECA.62']},
                {code: 'CECA.75', name: 'Acionamentos Hidráulicos e Pneumáticos', credits: 4, hours: 60, prerequisites: ['CECA.41', 'CECA.59']},
                {code: 'CECA.72', name: 'Controle Digital', credits: 4, hours: 60, prerequisites: ['CECA.059']},
                {code: 'CECA.66', name: 'Controle Estatístico de Processos', credits: 3, hours: 45, prerequisites: ['NC.38']},
                {code: 'CECA.71', name: 'Controle Preditivo', credits: 4, hours: 60, prerequisites: ['CECA.059']},
                {code: 'CECA.64', name: 'Gerência de Projetos', credits: 2, hours: 30, prerequisites: ['NC.37']},
                {code: 'CECA.74', name: 'Instrumentação Analítica I', credits: 4, hours: 60, prerequisites: ['CECA.059', 'NC.24']},
                {code: 'CECA.65', name: 'Manufatura Integrada', credits: 2, hours: 30, prerequisites: ['CECA.57']},
                {code: 'CECA.63', name: 'Projeto Final de Curso I', credits: 1, hours: 15, prerequisites: ['NC.37']},
                {code: 'CECA.70', name: 'Robótica', credits: 4, hours: 60, prerequisites: ['CECA.45']},
                {code: 'CECA.67', name: 'Segurança Digital', credits: 4, hours: 60, prerequisites: ['CECA.52', 'CECA.59']},
                {code: 'CECA.69', name: 'Sistemas Operacionais', credits: 4, hours: 60, prerequisites: ['CECA.37']}
            ],
            10: [
                {code: 'CECA.77', name: 'Administração para Engenharia', credits: 2, hours: 30, prerequisites: ['CECA.64', 'CECA.65']},
                {code: 'GECA.82', name: 'Controle Inteligente', credits: 4, hours: 60, prerequisites: ['CECA.60', 'CECA.71']},
                {code: 'CECA.78', name: 'Economia para Engenharia', credits: 2, hours: 30, prerequisites: []},
                {code: 'CECA.88', name: 'Educação para as Relações Étnico Raciais', credits: 3, hours: 45, prerequisites: []},
                {code: 'GECA.75', name: 'Empreendedorismo', credits: 2, hours: 30, prerequisites: []},
                {code: 'CECA.89', name: 'Inglês Instrumental', credits: 0, hours: 60, prerequisites: []},
                {code: 'CECA.84', name: 'Instrumentação Analítica II', credits: 4, hours: 60, prerequisites: ['CECA.42', 'CECA.74']},
                {code: 'CECA.79', name: 'Integração de Sistemas de Automação', credits: 4, hours: 60, prerequisites: ['CECA.67', 'CECA.69', 'CECA.70']},
                {code: 'CECA.94', name: 'LIBRAS', credits: 2, hours: 30, prerequisites: []},
                {code: 'CECA.76', name: 'Projeto Final de Curso II', credits: 1, hours: 15, prerequisites: ['CECA.63']},
                {code: 'CECA.85', name: 'Tópicos Especiais em Automação Integrada', credits: 4, hours: 60, prerequisites: []},
                {code: 'CECA.90', name: 'Tópicos Especiais em Gestão', credits: 4, hours: 60, prerequisites: []},
                {code: 'CECA.86', name: 'Tópicos Especiais em Instrumentação', credits: 4, hours: 60, prerequisites: []},
                {code: 'CECA.87', name: 'Tópicos Especiais em Sistemas Inteligentes', credits: 4, hours: 60, prerequisites: []}
            ]
        };

        let completedSubjects = [];
        let subjectGrades = {};
        let currentFilter = 'all';
        let currentTab = 'curriculum';
        let searchTerm = '';
        let charts = {};

        // Inicializar metas padrão
        if (goals.length === 0) {
            goals = [
                { id: 1, name: 'Concluir 1º Período', target: 7, current: 0, type: 'subjects' },
                { id: 2, name: 'Manter GPA acima de 8.0', target: 8.0, current: 0, type: 'gpa' },
                { id: 3, name: 'Concluir 50% do curso', target: 50, current: 0, type: 'percentage' }
            ];
            saveGoals();
        }

        function saveProgress() {
            if (db) {
                saveCompletedSubjects(completedSubjects);
            } else {
                // Fallback para localStorage
            localStorage.setItem('completedSubjects', JSON.stringify(completedSubjects));
            }
        }



        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }


        function switchTab(tabName) {
            // Atualizar botões de tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Atualizar conteúdo
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            currentTab = tabName;
            
            // Renderizar conteúdo específico da tab
            if (tabName === 'graduation') {
                updateGraduationPlan();
            } else if (tabName === 'analytics') {
                renderAnalytics();
            }
        }

        function searchSubjects() {
            searchTerm = document.getElementById('searchInput').value.toLowerCase();
            renderCurriculum();
        }


        function findSubjectByCode(code) {
            for (let semester in curriculumData) {
                for (let subject of curriculumData[semester]) {
                    if (subject.code === code) {
                        return subject;
                    }
                }
            }
            return null;
        }

        function isSubjectAvailable(subject) {
            if (completedSubjects.includes(subject.code)) {
                return 'completed';
            }
            
            for (let prerequisite of subject.prerequisites) {
                if (!completedSubjects.includes(prerequisite)) {
                    return 'blocked';
                }
            }
            
            return 'available';
        }

        function toggleSubject(subjectCode) {
            const index = completedSubjects.indexOf(subjectCode);
            if (index === -1) {
                completedSubjects.push(subjectCode);
                addChangeHistory('COMPLETED', subjectCode, 'Disciplina marcada como concluída');
                showNotification(`Disciplina ${subjectCode} marcada como concluída!`, 'success');
            } else {
                completedSubjects.splice(index, 1);
                addChangeHistory('UNCOMPLETED', subjectCode, 'Disciplina desmarcada');
                showNotification(`Disciplina ${subjectCode} desmarcada.`, 'warning');
            }
            
            // Salvar progresso
            saveProgress();
            
            // Re-renderizar o currículo imediatamente
            renderCurriculum();
            
            // Forçar atualização das estatísticas
            updateStats();
            
            // Atualizar alerta de disciplinas críticas
            updateCriticalAlert();
            
            // Forçar atualização das disciplinas críticas se estivermos na aba correta
            if (currentTab === 'analytics') {
                renderCriticalSubjects();
            }
        }


        function getPrerequisiteNames(prerequisites) {
            const names = [];
            for (let semester in curriculumData) {
                for (let subject of curriculumData[semester]) {
                    if (prerequisites.includes(subject.code)) {
                        names.push(subject.name);
                    }
                }
            }
            return names;
        }

        function updateStats() {
            let completed = 0, available = 0, blocked = 0, total = 0;
            
            for (let semester in curriculumData) {
                for (let subject of curriculumData[semester]) {
                    total++;
                    const status = isSubjectAvailable(subject);
                    if (status === 'completed') completed++;
                    else if (status === 'available') available++;
                    else blocked++;
                }
            }
            
            document.getElementById('completed-count').textContent = completed;
            document.getElementById('available-count').textContent = available;
            document.getElementById('blocked-count').textContent = blocked;
            document.getElementById('total-count').textContent = total;
        }


        function filterSemesters(filter) {
            currentFilter = filter;
            
            // Atualizar botões
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes('Todos os Períodos') && filter === 'all') {
                    btn.classList.add('active');
                } else if (btn.textContent.includes('Apenas Disponíveis') && filter === 'available') {
                    btn.classList.add('active');
                } else if (btn.textContent.includes('Apenas Concluídas') && filter === 'completed') {
                    btn.classList.add('active');
                } else if (btn.textContent.includes('Apenas Bloqueadas') && filter === 'blocked') {
                    btn.classList.add('active');
                }
            });
            
            renderCurriculum();
        }

        function shouldShowSemester(semesterSubjects) {
            if (currentFilter === 'all') return true;
            
            return semesterSubjects.some(subject => {
                const status = isSubjectAvailable(subject);
                return (currentFilter === 'available' && status === 'available') ||
                       (currentFilter === 'blocked' && status === 'blocked') ||
                       (currentFilter === 'completed' && status === 'completed');
            });
        }

        function shouldShowSubject(subject) {
            if (searchTerm === '') return true;
            
            return subject.name.toLowerCase().includes(searchTerm) ||
                   subject.code.toLowerCase().includes(searchTerm);
        }




        function calculateGPA() {
            // Função simplificada para calcular GPA
            // Como não temos notas, vamos usar um GPA baseado no progresso
            const totalSubjects = Object.values(curriculumData).flat().length;
            const completedCount = completedSubjects.length;
            if (totalSubjects === 0) return 0;
            
            // Simular GPA baseado no progresso (0-10)
            return Math.round((completedCount / totalSubjects) * 10 * 100) / 100;
        }

        function updateGPA() {
            // Função para atualizar o GPA (se necessário)
            // Por enquanto, apenas chama calculateGPA
            return calculateGPA();
        }

        function saveGrades() {
            // Função para salvar notas (se necessário)
            // Por enquanto, apenas salva no localStorage
            localStorage.setItem('subjectGrades', JSON.stringify({}));
        }



        function showBackupHistory() {
            const modal = document.getElementById('historyModal');
            const container = document.getElementById('backup-history');
            
            const backups = getBackups();
            const history = getChangeHistory(20);
            
            let html = '<div style="margin-bottom: 30px;">';
            html += '<h4><i class="fas fa-database"></i> Backups Disponíveis</h4>';
            
            if (backups.length === 0) {
                html += '<p style="color: #666; text-align: center; margin: 20px 0;">Nenhum backup encontrado.</p>';
            } else {
                html += '<div style="max-height: 200px; overflow-y: auto;">';
                backups.forEach(backup => {
                    const date = new Date(backup.created_at).toLocaleString('pt-BR');
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 5px 0;">
                            <div>
                                <strong>${backup.backup_name}</strong><br>
                                <small style="color: #666;">${date}</small>
                                ${backup.description ? `<br><small style="color: #888;">${backup.description}</small>` : ''}
                            </div>
                            <button onclick="restoreBackup(${backup.id})" style="background: var(--info-color); color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                                Restaurar
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '<button onclick="createBackup(\'Backup Manual\', \'Backup criado manualmente\')" style="background: var(--success-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">';
            html += '<i class="fas fa-plus"></i> Criar Backup Agora';
            html += '</button>';
            html += '</div>';
            
            html += '<div>';
            html += '<h4><i class="fas fa-history"></i> Histórico de Mudanças</h4>';
            
            if (history.length === 0) {
                html += '<p style="color: #666; text-align: center; margin: 20px 0;">Nenhuma mudança registrada.</p>';
            } else {
                html += '<div style="max-height: 300px; overflow-y: auto;">';
                history.forEach(change => {
                    const date = new Date(change.timestamp).toLocaleString('pt-BR');
                    const actionText = change.action === 'COMPLETED' ? '✅ Concluída' : 
                                     change.action === 'UNCOMPLETED' ? '❌ Desmarcada' : change.action;
                    html += `
                        <div style="padding: 8px; border-left: 3px solid var(--info-color); margin: 5px 0; background: #f8f9fa;">
                            <strong>${actionText}</strong>
                            ${change.subject_code ? ` - ${change.subject_code}` : ''}
                            <br><small style="color: #666;">${date}</small>
                            ${change.details ? `<br><small style="color: #888;">${change.details}</small>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }
            html += '</div>';
            
            container.innerHTML = html;
            modal.style.display = 'block';
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.completedSubjects) completedSubjects = data.completedSubjects;
                    if (data.subjectGrades) subjectGrades = data.subjectGrades;
                    
                    saveProgress();
                    saveGrades();
                    
                    renderCurriculum();
                    updateGPA();
                    
                    closeModal('importModal');
                    showNotification('Dados importados com sucesso!', 'success');
                } catch (error) {
                    showNotification('Erro ao importar arquivo. Verifique o formato.', 'error');
                }
            };
            reader.readAsText(file);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }



        function renderCurriculum() {
            const container = document.getElementById('semesters-container');
            container.innerHTML = '';
            
            for (let semester in curriculumData) {
                const semesterSubjects = curriculumData[semester];
                
                if (!shouldShowSemester(semesterSubjects)) continue;
                
                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'semester';
                
                const header = document.createElement('div');
                header.className = 'semester-header';
                header.textContent = `${semester}º Período`;
                semesterDiv.appendChild(header);
                
                for (let subject of semesterSubjects) {
                    const status = isSubjectAvailable(subject);
                    
                    if (currentFilter !== 'all') {
                        if ((currentFilter === 'available' && status !== 'available') ||
                            (currentFilter === 'blocked' && status !== 'blocked') ||
                            (currentFilter === 'completed' && status !== 'completed')) {
                            continue;
                        }
                    }
                    
                    // Filtro de busca
                    if (!shouldShowSubject(subject)) continue;
                    
                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = `subject ${status}`;
                    
                    // Aplicar classes de prioridade se necessário (apenas para disciplinas não concluídas)
                    if (status !== 'completed') {
                        const criticalSubjects = analyzeCriticalSubjectsForDisplay();
                        const criticalCodes = criticalSubjects.filter(s => s.totalImpact >= 15).map(s => s.code);
                        const highPriorityCodes = criticalSubjects.filter(s => s.totalImpact >= 8 && s.totalImpact < 15).map(s => s.code);
                        
                        if (criticalCodes.includes(subject.code)) {
                            subjectDiv.classList.add('subject-critical');
                        } else if (highPriorityCodes.includes(subject.code)) {
                            subjectDiv.classList.add('subject-high-priority');
                        }
                    }
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'subject-checkbox';
                    checkbox.checked = status === 'completed';
                    checkbox.disabled = status === 'blocked';
                    checkbox.onchange = () => toggleSubject(subject.code);
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'subject-content';
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'subject-header';
                    
                    const codeSpan = document.createElement('span');
                    codeSpan.className = 'subject-code';
                    codeSpan.textContent = subject.code;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'subject-name';
                    nameSpan.textContent = subject.name;
                    
                    headerDiv.appendChild(codeSpan);
                    headerDiv.appendChild(nameSpan);
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'subject-info';
                    infoDiv.textContent = `${subject.hours}h | ${subject.credits} créditos`;
                    
                    
                    contentDiv.appendChild(headerDiv);
                    contentDiv.appendChild(infoDiv);
                    
                    if (subject.prerequisites.length > 0 && status === 'blocked') {
                        const prereqDiv = document.createElement('div');
                        prereqDiv.className = 'prerequisites';
                        const prereqNames = getPrerequisiteNames(subject.prerequisites);
                        prereqDiv.innerHTML = `<strong>Pré-requisitos:</strong><br>${prereqNames.join(', ')}`;
                        contentDiv.appendChild(prereqDiv);
                    }
                    
                    subjectDiv.appendChild(checkbox);
                    subjectDiv.appendChild(contentDiv);
                    
                    if (status !== 'blocked') {
                        subjectDiv.onclick = (e) => {
                            if (e.target.type !== 'checkbox') {
                                checkbox.click();
                            }
                        };
                    }
                    
                    semesterDiv.appendChild(subjectDiv);
                }
                
                if (semesterDiv.children.length > 1) { // Se tem mais que só o header
                    container.appendChild(semesterDiv);
                }
            }
            
            updateStats();
            // Atualizar prioridades imediatamente
        }

        function resetProgress() {
            if (confirm('Tem certeza que deseja resetar todo o progresso?')) {
                completedSubjects = [];
                subjectGrades = {};
                plannedSemesters = [];
                saveProgress();
                saveGrades();
                savePlannedSemesters();
                renderCurriculum();
                updateGPA();
                updateGoals();
                showNotification('Progresso resetado com sucesso!', 'success');
            }
        }

        function renderAnalytics() {
            // Renderizar disciplinas críticas
            renderCriticalSubjects();
            
            // Inicializar gráficos de análise se ainda não foram criados
            setTimeout(() => {
                initializeAnalyticsCharts();
            }, 100);
        }

        function initializeAnalyticsCharts() {
            // Gráfico de timeline
            const timelineCtx = document.getElementById('timelineChart');
            if (timelineCtx && !charts.timeline) {
                const estimatedCompletion = calculateEstimatedCompletion();
                
                charts.timeline = new Chart(timelineCtx, {
                    type: 'line',
                    data: {
                        labels: estimatedCompletion.labels,
                        datasets: [{
                            label: 'Progresso Estimado',
                            data: estimatedCompletion.data,
                            borderColor: 'rgba(102, 126, 234, 1)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            // Gráfico de pré-requisitos
            const prereqCtx = document.getElementById('prerequisitesChart');
            if (prereqCtx && !charts.prerequisites) {
                const prereqData = analyzePrerequisites();
                
                charts.prerequisites = new Chart(prereqCtx, {
                    type: 'bar',
                    data: {
                        labels: prereqData.labels,
                        datasets: [{
                            label: 'Disciplinas Bloqueadas',
                            data: prereqData.data,
                            backgroundColor: 'rgba(231, 76, 60, 0.8)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Gráfico de impacto das disciplinas
            const impactCtx = document.getElementById('impactChart');
            if (impactCtx && !charts.impact) {
                const impactData = calculateSubjectImpact();
                
                charts.impact = new Chart(impactCtx, {
                    type: 'horizontalBar',
                    data: {
                        labels: impactData.labels,
                        datasets: [{
                            label: 'Disciplinas Bloqueadas',
                            data: impactData.data,
                            backgroundColor: [
                                'rgba(231, 76, 60, 0.8)',
                                'rgba(243, 156, 18, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(155, 89, 182, 0.8)',
                                'rgba(46, 204, 113, 0.8)',
                                'rgba(26, 188, 156, 0.8)',
                                'rgba(52, 73, 94, 0.8)',
                                'rgba(149, 165, 166, 0.8)',
                                'rgba(230, 126, 34, 0.8)',
                                'rgba(192, 57, 43, 0.8)'
                            ],
                            borderColor: [
                                'rgba(231, 76, 60, 1)',
                                'rgba(243, 156, 18, 1)',
                                'rgba(52, 152, 219, 1)',
                                'rgba(155, 89, 182, 1)',
                                'rgba(46, 204, 113, 1)',
                                'rgba(26, 188, 156, 1)',
                                'rgba(52, 73, 94, 1)',
                                'rgba(149, 165, 166, 1)',
                                'rgba(230, 126, 34, 1)',
                                'rgba(192, 57, 43, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Gráfico de gargalos
            const bottleneckCtx = document.getElementById('bottleneckChart');
            if (bottleneckCtx && !charts.bottleneck) {
                const bottleneckData = calculateBottlenecks();
                const labels = Object.keys(bottleneckData);
                const data = labels.map(label => bottleneckData[label].percentage);
                
                charts.bottleneck = new Chart(bottleneckCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                'rgba(231, 76, 60, 0.8)',
                                'rgba(243, 156, 18, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(155, 89, 182, 0.8)',
                                'rgba(46, 204, 113, 0.8)'
                            ],
                            borderColor: [
                                'rgba(231, 76, 60, 1)',
                                'rgba(243, 156, 18, 1)',
                                'rgba(52, 152, 219, 1)',
                                'rgba(155, 89, 182, 1)',
                                'rgba(46, 204, 113, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function calculateEstimatedCompletion() {
            const totalSubjects = Object.values(curriculumData).flat().length;
            const completed = completedSubjects.length;
            const remaining = totalSubjects - completed;
            
            // Estimativa baseada em 6 disciplinas por semestre
            const semestersRemaining = Math.ceil(remaining / 6);
            const currentSemester = Math.ceil(completed / 6);
            
            const labels = [];
            const data = [];
            
            for (let i = 0; i <= semestersRemaining; i++) {
                const semester = currentSemester + i;
                labels.push(`${semester}º Período`);
                const progress = Math.min(((completed + (i * 6)) / totalSubjects) * 100, 100);
                data.push(progress);
            }
            
            return { labels, data };
        }

        function analyzePrerequisites() {
            const prereqCount = {};
            
            for (let semester in curriculumData) {
                for (let subject of curriculumData[semester]) {
                    if (subject.prerequisites.length > 0) {
                        const prereqName = subject.prerequisites[0]; // Usar o primeiro pré-requisito
                        prereqCount[prereqName] = (prereqCount[prereqName] || 0) + 1;
                    }
                }
            }
            
            const labels = Object.keys(prereqCount).slice(0, 10); // Top 10
            const data = labels.map(label => prereqCount[label]);
            
            return { labels, data };
        }

        function analyzeCriticalSubjects() {
            const subjectImpact = {};
            const subjectDependencies = {};
            const subjectCascadeImpact = {};
            
            // Primeiro, calcular dependências diretas
            for (let semester in curriculumData) {
                for (let subject of curriculumData[semester]) {
                    subjectImpact[subject.code] = 0;
                    subjectDependencies[subject.code] = [];
                    
                    // Contar quantas disciplinas dependem diretamente desta
                    for (let otherSemester in curriculumData) {
                        for (let otherSubject of curriculumData[otherSemester]) {
                            if (otherSubject.prerequisites.includes(subject.code)) {
                                subjectImpact[subject.code]++;
                                subjectDependencies[subject.code].push(otherSubject.code);
                            }
                        }
                    }
                }
            }
            
            // Agora calcular o impacto em cascata (dependências indiretas)
            for (let subjectCode in subjectDependencies) {
                subjectCascadeImpact[subjectCode] = calculateCascadeImpact(subjectCode, subjectDependencies, new Set());
            }
            
            // Ordenar por impacto total (direto + cascata)
            const sortedSubjects = Object.keys(subjectImpact)
                .map(code => ({
                    code,
                    name: findSubjectByCode(code)?.name || '',
                    directImpact: subjectImpact[code],
                    cascadeImpact: subjectCascadeImpact[code],
                    totalImpact: subjectImpact[code] + subjectCascadeImpact[code],
                    dependencies: subjectDependencies[code],
                    isCompleted: completedSubjects.includes(code),
                    status: isSubjectAvailable(findSubjectByCode(code)),
                    semester: findSubjectSemester(code)
                }))
                .filter(subject => subject.totalImpact > 0)
                .sort((a, b) => b.totalImpact - a.totalImpact);
            
            return sortedSubjects;
        }

        function analyzeCriticalSubjectsForDisplay() {
            // Esta função retorna apenas disciplinas críticas que ainda não foram concluídas
            const allCriticalSubjects = analyzeCriticalSubjects();
            
            // Filtrar apenas disciplinas não concluídas para exibição
            const uncompletedCritical = allCriticalSubjects.filter(subject => !subject.isCompleted);
            
            return uncompletedCritical;
        }

        function calculateCascadeImpact(subjectCode, allDependencies, visited) {
            if (visited.has(subjectCode)) {
                return 0; // Evitar loops infinitos
            }
            
            visited.add(subjectCode);
            let cascadeCount = 0;
            
            // Para cada disciplina que depende diretamente desta
            const directDeps = allDependencies[subjectCode] || [];
            for (let depCode of directDeps) {
                // Contar esta dependência
                cascadeCount++;
                
                // Recursivamente contar as dependências desta dependência
                cascadeCount += calculateCascadeImpact(depCode, allDependencies, new Set(visited));
            }
            
            return cascadeCount;
        }

        function findSubjectSemester(subjectCode) {
            for (let semester in curriculumData) {
                for (let subject of curriculumData[semester]) {
                    if (subject.code === subjectCode) {
                        return parseInt(semester);
                    }
                }
            }
            return 0;
        }

        function buildDependencyChain(subjectCode) {
            const chain = [];
            const visited = new Set();
            
            function buildChain(currentCode, depth = 0) {
                if (visited.has(currentCode) || depth > 10) return; // Evitar loops e profundidade excessiva
                
                visited.add(currentCode);
                const subject = findSubjectByCode(currentCode);
                if (!subject) return;
                
                chain.push({
                    code: currentCode,
                    name: subject.name,
                    semester: findSubjectSemester(currentCode),
                    depth: depth,
                    isCompleted: completedSubjects.includes(currentCode)
                });
                
                // Encontrar disciplinas que dependem desta
                for (let semester in curriculumData) {
                    for (let otherSubject of curriculumData[semester]) {
                        if (otherSubject.prerequisites.includes(currentCode)) {
                            buildChain(otherSubject.code, depth + 1);
                        }
                    }
                }
            }
            
            buildChain(subjectCode);
            return chain.sort((a, b) => a.semester - b.semester);
        }

        function renderCriticalSubjects() {
            const criticalSubjects = analyzeCriticalSubjectsForDisplay(); // Usar apenas disciplinas não concluídas
            const container = document.getElementById('critical-subjects-list');
            
            if (criticalSubjects.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.8;">🎉 Parabéns! Não há disciplinas críticas pendentes.</p>';
                return;
            }
            
            container.innerHTML = '';
            
            // Mostrar top 5 disciplinas mais críticas (apenas não concluídas)
            const topCritical = criticalSubjects.slice(0, 5);
            
            topCritical.forEach((subject, index) => {
                const subjectDiv = document.createElement('div');
                subjectDiv.className = 'critical-subject';
                
                const priority = subject.totalImpact >= 15 ? 'critical' : 
                                subject.totalImpact >= 8 ? 'high' : 'medium';
                
                subjectDiv.innerHTML = `
                    <div class="critical-subject-info">
                        <div class="critical-subject-code">
                            ${subject.code} (${subject.semester}º Período)
                            <span class="priority-badge priority-${priority}">
                                ${priority === 'critical' ? 'CRÍTICA' : 
                                  priority === 'high' ? 'ALTA' : 'MÉDIA'}
                            </span>
                        </div>
                        <div class="critical-subject-name">${subject.name}</div>
                        <div style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">
                            ${subject.isCompleted ? '✅ Concluída' : 
                              subject.status === 'available' ? '🟢 Disponível' : 
                              subject.status === 'blocked' ? '🔴 Bloqueada' : '⚪ Não disponível'}
                        </div>
                        <div style="font-size: 0.75em; opacity: 0.7; margin-top: 3px;">
                            Impacto direto: ${subject.directImpact} | Cascata: ${subject.cascadeImpact}
                        </div>
                    </div>
                    <div class="critical-subject-impact">
                        <div class="impact-number">${subject.totalImpact}</div>
                        <div class="impact-label">total<br>bloqueadas</div>
                    </div>
                `;
                
                // Adicionar botão para ver cadeia de dependências
                const chainButton = document.createElement('button');
                chainButton.innerHTML = '<i class="fas fa-sitemap"></i>';
                chainButton.style.cssText = `
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    padding: 8px;
                    border-radius: 5px;
                    cursor: pointer;
                    margin-left: 10px;
                    transition: all 0.3s ease;
                `;
                chainButton.onmouseover = () => chainButton.style.background = 'rgba(255,255,255,0.3)';
                chainButton.onmouseout = () => chainButton.style.background = 'rgba(255,255,255,0.2)';
                chainButton.onclick = () => showDependencyChain(subject.code, subject.name);
                
                subjectDiv.appendChild(chainButton);
                container.appendChild(subjectDiv);
            });
            
            // Adicionar alerta se houver disciplinas críticas não concluídas
            const uncompletedCritical = topCritical.filter(s => !s.isCompleted && s.totalImpact >= 15);
            if (uncompletedCritical.length > 0) {
                showCriticalAlert(uncompletedCritical);
            }
        }

        function showDependencyChain(subjectCode, subjectName) {
            const chain = buildDependencyChain(subjectCode);
            
            // Criar modal para mostrar a cadeia
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>🔗 Cadeia de Dependências: ${subjectCode}</h3>
                    <p style="margin-bottom: 20px; color: #666;">${subjectName}</p>
                    <div id="dependency-chain" style="max-height: 400px; overflow-y: auto;">
                        ${renderDependencyChain(chain)}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function renderDependencyChain(chain) {
            if (chain.length === 0) {
                return '<p style="text-align: center; color: #666;">Nenhuma dependência encontrada.</p>';
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            chain.forEach((item, index) => {
                const isCompleted = item.isCompleted;
                const depth = item.depth;
                const indent = '&nbsp;'.repeat(depth * 4);
                
                html += `
                    <div style="
                        padding: 10px;
                        border-radius: 8px;
                        background: ${isCompleted ? '#d4edda' : '#f8d7da'};
                        border-left: 4px solid ${isCompleted ? '#28a745' : '#dc3545'};
                        margin-left: ${depth * 20}px;
                    ">
                        <div style="font-weight: bold; color: ${isCompleted ? '#155724' : '#721c24'};">
                            ${indent}${item.code} - ${item.name}
                        </div>
                        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                            ${indent}${item.semester}º Período ${isCompleted ? '✅ Concluída' : '⏳ Pendente'}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function updateCriticalAlert() {
            // Remover TODOS os alertas anteriores
            const existingAlerts = document.querySelectorAll('.alert-banner');
            existingAlerts.forEach(alert => alert.remove());
            
            // Verificar disciplinas críticas atuais
            const criticalSubjects = analyzeCriticalSubjectsForDisplay();
            const uncompletedCritical = criticalSubjects.filter(s => s.totalImpact >= 15);
            
            // Mostrar novo alerta se houver disciplinas críticas
            if (uncompletedCritical.length > 0) {
                showCriticalAlert(uncompletedCritical);
            }
        }

        function showCriticalAlert(criticalSubjects) {
            // Garantir que não há alertas duplicados
            const existingAlerts = document.querySelectorAll('.alert-banner');
            existingAlerts.forEach(alert => alert.remove());
            
            const totalBlocked = criticalSubjects.reduce((sum, s) => sum + s.totalImpact, 0);
            const criticalCount = criticalSubjects.length;
            
            const alertBanner = document.createElement('div');
            alertBanner.className = 'alert-banner';
            alertBanner.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <div class="alert-banner-content">
                    <div class="alert-banner-title">⚠️ ALERTA: Efeito Dominó Detectado!</div>
                    <div class="alert-banner-message">
                        <strong>${criticalCount} disciplina(s) crítica(s)</strong> podem travar todo seu curso!
                        <br>
                        <strong>${criticalSubjects.map(s => s.code).join(', ')}</strong> bloqueiam <strong>${totalBlocked} disciplinas</strong> no total (incluindo efeito cascata).
                        <br>
                        <em>💡 Dica: Priorize estas disciplinas para evitar atrasos em cadeia!</em>
                    </div>
                </div>
            `;
            
            // Inserir o alerta no topo da página (sempre visível)
            const container = document.querySelector('.container');
            container.insertBefore(alertBanner, container.firstChild);
        }

        function updateSubjectPriorities() {
            // Esta função agora é chamada apenas para atualizar as disciplinas críticas na aba de analytics
            // As classes de prioridade são aplicadas diretamente no renderCurriculum
            renderCriticalSubjects();
        }

        function generateGraduationPlan() {
            const includeCompleted = document.getElementById('includeCompleted').checked;
            
            // Calcular o semestre atual baseado nas disciplinas concluídas
            let currentSemester = 1;
            if (completedSubjects.length > 0) {
                // Encontrar o semestre mais avançado entre as disciplinas concluídas
                const completedSemesters = completedSubjects.map(code => {
                    for (let semester in curriculumData) {
                        const subject = curriculumData[semester].find(s => s.code === code);
                        if (subject) return parseInt(semester);
                    }
                    return 0;
                });
                currentSemester = Math.max(...completedSemesters) + 1;
            }
            
            // Coletar todas as disciplinas restantes
            const allRemainingSubjects = [];
            for (let semester in curriculumData) {
                for (let subject of curriculumData[semester]) {
                    if (!includeCompleted && completedSubjects.includes(subject.code)) {
                        continue; // Pular disciplinas concluídas se não incluir
                    }
                    if (!completedSubjects.includes(subject.code)) {
                        allRemainingSubjects.push({
                            ...subject,
                            originalSemester: parseInt(semester)
                        });
                    }
                }
            }
            
            // Algoritmo de planejamento inteligente
            const plan = [];
            const completed = new Set(completedSubjects);
            const remaining = [...allRemainingSubjects];
            let planningSemester = 1; // Sempre começar do semestre 1
            
            while (remaining.length > 0) {
                const semesterSubjects = [];
                
                // Encontrar disciplinas que podem ser feitas neste semestre
                const available = remaining.filter(subject => {
                    // Verificar se todos os pré-requisitos foram concluídos
                    return subject.prerequisites.every(prereq => completed.has(prereq));
                });
                
                // Ordenar por prioridade (disciplinas críticas primeiro, depois por semestre original)
                const criticalSubjects = analyzeCriticalSubjects();
                const criticalCodes = new Set(criticalSubjects.map(s => s.code));
                
                available.sort((a, b) => {
                    const aCritical = criticalCodes.has(a.code);
                    const bCritical = criticalCodes.has(b.code);
                    
                    if (aCritical && !bCritical) return -1;
                    if (!aCritical && bCritical) return 1;
                    
                    // Se ambos são críticos ou não críticos, ordenar por semestre original
                    return a.originalSemester - b.originalSemester;
                });
                
                // Adicionar disciplinas até o limite do semestre (baseado no currículo original)
                const maxSubjectsPerSemester = 8; // Limite máximo por semestre
                for (let i = 0; i < Math.min(maxSubjectsPerSemester, available.length); i++) {
                    const subject = available[i];
                    
                    // Verificar se algum pré-requisito está sendo feito no mesmo semestre
                    const hasPrerequisiteInSameSemester = subject.prerequisites.some(prereq => 
                        semesterSubjects.some(s => s.code === prereq)
                    );
                    
                    // Se tem pré-requisito no mesmo semestre, pular esta disciplina
                    if (hasPrerequisiteInSameSemester) {
                        continue;
                    }
                    
                    semesterSubjects.push(subject);
                    completed.add(subject.code);
                    
                    // Remover da lista de restantes
                    const index = remaining.findIndex(s => s.code === subject.code);
                    if (index !== -1) {
                        remaining.splice(index, 1);
                    }
                }
                
                if (semesterSubjects.length > 0) {
                    plan.push({
                        semester: planningSemester,
                        subjects: semesterSubjects
                    });
                }
                
                planningSemester++;
                
                // Proteção contra loop infinito
                if (planningSemester > 20) {
                    console.warn('Planejamento interrompido - possível loop infinito');
                    break;
                }
            }
            
            return plan;
        }

        function updateGraduationPlan() {
            if (currentTab !== 'graduation') return;
            
            const plan = generateGraduationPlan();
            const totalSubjects = plan.reduce((sum, semester) => sum + semester.subjects.length, 0);
            const totalSemesters = plan.length;
            const totalYears = Math.ceil(totalSemesters / 2);
            const avgSubjectsPerSemester = totalSemesters > 0 ? (totalSubjects / totalSemesters).toFixed(1) : 0;
            
            // Atualizar estatísticas
            document.getElementById('total-semesters').textContent = totalSemesters;
            document.getElementById('total-years').textContent = totalYears;
            document.getElementById('avg-subjects-per-semester').textContent = avgSubjectsPerSemester;
            
            // Renderizar cronograma
            renderGraduationTimeline(plan);
        }

        function renderGraduationTimeline(plan) {
            const container = document.getElementById('graduation-timeline');
            container.innerHTML = '';
            
            if (plan.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">🎉 Parabéns! Você já concluiu todas as disciplinas!</p>';
                return;
            }
            
            plan.forEach(semesterPlan => {
                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'semester-plan';
                
                const completedCount = semesterPlan.subjects.filter(s => completedSubjects.includes(s.code)).length;
                const criticalCount = semesterPlan.subjects.filter(s => {
                    const criticalSubjects = analyzeCriticalSubjects();
                    return criticalSubjects.some(cs => cs.code === s.code && cs.totalImpact >= 15);
                }).length;
                
                semesterDiv.innerHTML = `
                    <div class="semester-plan-header">
                        <div class="semester-plan-title">${semesterPlan.semester}º Semestre</div>
                        <div class="semester-plan-stats">
                            ${semesterPlan.subjects.length} disciplinas | 
                            ${completedCount} concluídas | 
                            ${criticalCount} críticas
                        </div>
                    </div>
                    <div class="semester-subjects">
                        ${semesterPlan.subjects.map(subject => {
                            const isCompleted = completedSubjects.includes(subject.code);
                            const criticalSubjects = analyzeCriticalSubjects();
                            const isCritical = criticalSubjects.some(cs => cs.code === subject.code && cs.totalImpact >= 15);
                            const isHighPriority = criticalSubjects.some(cs => cs.code === subject.code && cs.totalImpact >= 8 && cs.totalImpact < 15);
                            
                            let classes = 'planned-subject';
                            if (isCompleted) classes += ' completed';
                            if (isCritical) classes += ' critical';
                            else if (isHighPriority) classes += ' high-priority';
                            
                            return `
                                <div class="${classes}">
                                    <div class="planned-subject-code">${subject.code}</div>
                                    <div class="planned-subject-name">${subject.name}</div>
                                    <div class="planned-subject-info">
                                        ${isCompleted ? '✅ Concluída' : 
                                          isCritical ? '🔴 Crítica' : 
                                          isHighPriority ? '🟡 Alta Prioridade' : '⚪ Normal'}
                                        ${subject.prerequisites.length > 0 ? ` | Pré-requisitos: ${subject.prerequisites.join(', ')}` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                container.appendChild(semesterDiv);
            });
        }

        function calculateSubjectImpact() {
            const impactData = analyzeCriticalSubjectsForDisplay(); // Usar apenas disciplinas não concluídas
            return {
                labels: impactData.slice(0, 10).map(s => s.code),
                data: impactData.slice(0, 10).map(s => s.totalImpact)
            };
        }

        function calculateBottlenecks() {
            const criticalSubjects = analyzeCriticalSubjectsForDisplay(); // Usar apenas disciplinas não concluídas
            const bottlenecks = {};
            
            // Agrupar por período para identificar gargalos
            for (let semester in curriculumData) {
                const semesterSubjects = curriculumData[semester];
                let criticalCount = 0;
                let totalSubjects = semesterSubjects.length;
                
                semesterSubjects.forEach(subject => {
                    const critical = criticalSubjects.find(cs => cs.code === subject.code);
                    if (critical && critical.totalImpact >= 5) {
                        criticalCount++;
                    }
                });
                
                if (criticalCount > 0) {
                    bottlenecks[`${semester}º Período`] = {
                        critical: criticalCount,
                        total: totalSubjects,
                        percentage: Math.round((criticalCount / totalSubjects) * 100)
                    };
                }
            }
            
            return bottlenecks;
        }

        // Inicializar a aplicação
        async function initializeApp() {
            // Log de inicialização do sistema
            console.log(`🚀 Sistema de Acompanhamento Acadêmico v${APP_VERSION}`);
            console.log(`👨‍💻 Desenvolvido por: ${APP_AUTHOR}`);
            console.log(`🏫 Instituição: ${APP_INSTITUTION}`);
            
            // Inicializar SQLite
            const sqliteInitialized = await initSQLite();
            
            if (sqliteInitialized) {
                // Carregar dados do banco SQLite
                completedSubjects = loadCompletedSubjects();
                console.log('Dados carregados do SQLite');
            } else {
                // Fallback para localStorage
                completedSubjects = JSON.parse(localStorage.getItem('completedSubjects')) || [];
                console.log('Usando localStorage como fallback');
            }
            
            
            // Adicionar event listeners
            document.getElementById('searchInput').addEventListener('input', searchSubjects);
            
            // Fechar modais ao clicar fora
            window.onclick = function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }
            
            // Aplicar filtro "Todos os Períodos" automaticamente primeiro
            filterSemesters('all');
            
            // Renderizar conteúdo inicial
            renderCurriculum();
            updateStats();
            
            // Verificar disciplinas críticas e mostrar alertas se necessário
            setTimeout(() => {
                const criticalSubjects = analyzeCriticalSubjectsForDisplay();
                const uncompletedCritical = criticalSubjects.filter(s => s.totalImpact >= 15);
                if (uncompletedCritical.length > 0) {
                    showCriticalAlert(uncompletedCritical);
                }
            }, 1000);
            
            // Criar backup inicial se for primeira vez
            if (sqliteInitialized && getBackups().length === 0) {
                createBackup('Backup Inicial', 'Primeiro backup do sistema');
            }
            
            showNotification('Sistema carregado com sucesso!', 'success');
        }

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>